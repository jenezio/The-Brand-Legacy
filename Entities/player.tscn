[gd_scene load_steps=39 format=3 uid="uid://ditjcd3xtjpu8"]

[ext_resource type="Texture2D" uid="uid://dtsai5184qohq" path="res://Sprites/Idle.png" id="2_gb1tc"]
[ext_resource type="Texture2D" uid="uid://1s20avgesdoq" path="res://Sprites/Attacks_shorted2.PNG" id="2_kee72"]
[ext_resource type="Texture2D" uid="uid://b4035ge8e0lm0" path="res://Sprites/Jump.png" id="3_taegk"]
[ext_resource type="Texture2D" uid="uid://dljlymves2eej" path="res://Sprites/Run.png" id="3_xd3k7"]

[sub_resource type="GDScript" id="GDScript_taegk"]
script/source = "extends CharacterBody2D

# -----------------
# @ONREADY E EXPORTS
# -----------------
@onready var anim: AnimatedSprite2D = $AnimatedSprite2D
@onready var attack_area: Area2D = $Area2D_Ataque

@export var speed := 120.0
@export var jump_force := -300.0
@export var gravity := 900.0
@export var max_vidas := 3

# -----------------
# VARIÁVEIS DE ESTADO
# -----------------
var is_attacking := false
var has_damaged := false
var vidas := 3
var is_dead := false 

# -----------------
# FUNÇÕES NATIVAS
# -----------------
func _ready():
	vidas = max_vidas
	attack_area.monitoring = false
	
	# Garante a conexão da animação via código
	if not anim.animation_finished.is_connected(_on_animated_sprite_2d_animation_finished):
		anim.animation_finished.connect(_on_animated_sprite_2d_animation_finished)

func _physics_process(delta):
	if is_dead:
		velocity = Vector2.ZERO
		move_and_slide()
		return 
	
	# === A LÓGICA DE SEGURANÇA FOI MOVIDA PARA CÁ (Linhas 40-43 anteriores) ===
	# --- Lógica de Segurança (Resetar ataque se a animação falhar) ---
	if is_attacking and anim.animation != \"attack_model1\":
		is_attacking = false
		attack_area.monitoring = false
		has_damaged = false
		
	# --- ATAQUE ---
	if Input.is_action_just_pressed(\"ataque\") and is_on_floor() and not is_attacking:
		is_attacking = true
		has_damaged = false
		velocity.x = 0
		attack_area.monitoring = true
		anim.play(\"attack_model1\")

	# --- MOVIMENTO (desativado durante ataque) ---
	if not is_attacking:
		# Pulo
		if Input.is_action_just_pressed(\"ui_accept\") and is_on_floor():
			velocity.y = jump_force

		# Andar
		var direction := Input.get_axis(\"ui_left\", \"ui_right\")

		if direction:
			velocity.x = direction * speed
			anim.scale.x = direction
		else:
			velocity.x = move_toward(velocity.x, 0, speed)

		# ANIMAÇÕES
		if not is_on_floor():
			if anim.animation != \"jump\":
				anim.play(\"jump\")
		else:
			if direction:
				if anim.animation != \"walk\":
					anim.play(\"walk\")
			else:
				if anim.animation != \"idle\":
					anim.play(\"idle\")

	# Gravidade
	if not is_on_floor():
		velocity.y += gravity * delta
		
	move_and_slide()

# -----------------
# FUNÇÕES DE ESTADO
# -----------------
# Reseta o estado de ataque
func _on_animated_sprite_2d_animation_finished():
	if anim.animation == \"attack_model1\":
		is_attacking = false
		attack_area.monitoring = false
		has_damaged = false
	
	# Morte do Player
	if anim.animation == \"death\":
		queue_free()

# Jogador toma dano
func take_damage(amount: int):
	if is_dead:
		return

	vidas -= amount
	print(\"Vidas restantes (Player): \", vidas)
	
	if vidas <= 0:
		is_dead = true
		velocity = Vector2.ZERO
		
		print(\"Player morreu\")
		
		if anim.has_animation(\"death\"):
			anim.play(\"death\")
		else:
			queue_free()

# -----------------
# FUNÇÕES DE COLISÃO
# -----------------
# Dano no Inimigo (Conectado ao sinal 'body_entered' do Area2D_Ataque)
func _on_area_2d_ataque_body_entered(body: Node2D): 
	if is_attacking and not has_damaged:
		if body.is_in_group(\"Enemy\"):
			var enemy = body as CharacterBody2D 
			if enemy != null and enemy.has_method(\"take_damage\"):
				
				if !enemy.is_hitting and !enemy.is_dead: 
					enemy.take_damage(1)
					has_damaged = true
"

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_ypkcv"]
radius = 13.0
height = 46.0

[sub_resource type="AtlasTexture" id="AtlasTexture_x5h13"]
atlas = ExtResource("2_kee72")
region = Rect2(0, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_o0d5x"]
atlas = ExtResource("2_kee72")
region = Rect2(128, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_5d2js"]
atlas = ExtResource("2_kee72")
region = Rect2(256, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_8qynv"]
atlas = ExtResource("2_kee72")
region = Rect2(384, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_kksrn"]
atlas = ExtResource("2_kee72")
region = Rect2(512, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_jcafi"]
atlas = ExtResource("2_kee72")
region = Rect2(640, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_qbc8u"]
atlas = ExtResource("2_kee72")
region = Rect2(768, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_738w2"]
atlas = ExtResource("2_kee72")
region = Rect2(896, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_b1m20"]
atlas = ExtResource("2_kee72")
region = Rect2(0, 64, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_w8hnq"]
atlas = ExtResource("2_kee72")
region = Rect2(128, 64, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_xd3k7"]
atlas = ExtResource("2_gb1tc")
region = Rect2(14, 0, 107, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_taegk"]
atlas = ExtResource("2_gb1tc")
region = Rect2(14, 64, 107, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_kee72"]
atlas = ExtResource("2_gb1tc")
region = Rect2(14, 128, 107, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_prmdv"]
atlas = ExtResource("2_gb1tc")
region = Rect2(14, 192, 107, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_pg4qw"]
atlas = ExtResource("3_taegk")
region = Rect2(0, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_25cb4"]
atlas = ExtResource("3_taegk")
region = Rect2(128, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_uck12"]
atlas = ExtResource("3_taegk")
region = Rect2(0, 64, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_mat3c"]
atlas = ExtResource("3_taegk")
region = Rect2(128, 64, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ffc7a"]
atlas = ExtResource("3_taegk")
region = Rect2(0, 128, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_irn06"]
atlas = ExtResource("3_taegk")
region = Rect2(128, 128, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_v3fwn"]
atlas = ExtResource("3_taegk")
region = Rect2(0, 192, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_f8jwp"]
atlas = ExtResource("3_taegk")
region = Rect2(128, 192, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_s1j76"]
atlas = ExtResource("3_xd3k7")
region = Rect2(0, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_6jj0l"]
atlas = ExtResource("3_xd3k7")
region = Rect2(128, 0, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ua6mu"]
atlas = ExtResource("3_xd3k7")
region = Rect2(0, 64, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_xy0x1"]
atlas = ExtResource("3_xd3k7")
region = Rect2(128, 64, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_xakct"]
atlas = ExtResource("3_xd3k7")
region = Rect2(0, 128, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_k47j4"]
atlas = ExtResource("3_xd3k7")
region = Rect2(128, 128, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_klb6e"]
atlas = ExtResource("3_xd3k7")
region = Rect2(0, 192, 128, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_eyssl"]
atlas = ExtResource("3_xd3k7")
region = Rect2(128, 192, 128, 64)

[sub_resource type="SpriteFrames" id="SpriteFrames_s1j76"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_x5h13")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_o0d5x")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_5d2js")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_8qynv")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_kksrn")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_jcafi")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_qbc8u")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_738w2")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_b1m20")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_w8hnq")
}],
"loop": false,
"name": &"attack_model1",
"speed": 10.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_xd3k7")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_taegk")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_kee72")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_prmdv")
}],
"loop": true,
"name": &"idle",
"speed": 10.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_pg4qw")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_25cb4")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_uck12")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_mat3c")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ffc7a")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_irn06")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_v3fwn")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_f8jwp")
}],
"loop": false,
"name": &"jump",
"speed": 10.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_s1j76")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_6jj0l")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ua6mu")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_xy0x1")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_xakct")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_k47j4")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_klb6e")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_eyssl")
}],
"loop": true,
"name": &"walk",
"speed": 10.0
}]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_taegk"]
radius = 8.0
height = 42.0

[node name="Player" type="CharacterBody2D" groups=["Player"]]
position = Vector2(69, 81)
collision_layer = 8
collision_mask = 3
script = SubResource("GDScript_taegk")

[node name="CollisionShape2D" type="CollisionShape2D" parent="." groups=["Player"]]
position = Vector2(10, -2)
shape = SubResource("CapsuleShape2D_ypkcv")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="." groups=["Player"]]
position = Vector2(12, -10)
scale = Vector2(0.87843156, 0.9375)
sprite_frames = SubResource("SpriteFrames_s1j76")
animation = &"idle"
autoplay = "idle"
frame_progress = 0.47799292

[node name="Camera2D" type="Camera2D" parent="." groups=["Player"]]
limit_left = 1
limit_top = 12
limit_right = 10000001
limit_bottom = 212
position_smoothing_enabled = true

[node name="Area2D_Ataque" type="Area2D" parent="."]
collision_layer = 4
collision_mask = 2
monitoring = false

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area2D_Ataque" groups=["Player"]]
position = Vector2(21, -2)
shape = SubResource("CapsuleShape2D_taegk")

[connection signal="animation_finished" from="AnimatedSprite2D" to="." method="_on_animated_sprite_2d_animation_finished"]
[connection signal="body_entered" from="Area2D_Ataque" to="." method="_on_area_2d_ataque_body_entered"]
